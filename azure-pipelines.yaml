trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/**

stages:
- stage: Terraform
  displayName: 'Provision Infrastructure'
  jobs:
  - job: Terraform_Apply
    displayName: 'Terraform Apply'
    pool:
      name: 'self-hosted-agent'

    steps:
    # ‚úÖ Step 1: Download SSH Public Key
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'book-review-ssh.pub'

    # ‚úÖ Step 2: Copy SSH key into Terraform compute module
    - script: |
        echo "Copying SSH public key into Terraform module..."
        mkdir -p ~/.ssh
        cp "$(download_ssh_key.secureFilePath)" ~/.ssh/id_rsa.pub

        # Copy to Terraform compute module folder
        cp "$(download_ssh_key.secureFilePath)" terraform/modules/compute/id_rsa.pub

        echo "Listing contents of terraform/modules/compute/"
        ls -al terraform/modules/compute/
      displayName: 'Prepare SSH Public Key'

    # ‚úÖ Step 3: Terraform Init/Plan/Apply
    - task: AzureCLI@2
      displayName: 'Run Terraform'
      inputs:
        azureSubscription: 'book-review-sp'  # üîÅ must match the service connection name in Azure DevOps
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          echo "##[group]Terraform Init/Plan/Apply"
          terraform init -input=false 
          terraform plan -input=false -var-file="envs/dev.tfvars"
          terraform apply -input=false -auto-approve -var-file="envs/dev.tfvars"
          echo "##[endgroup]"
